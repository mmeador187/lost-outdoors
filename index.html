<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lost Outdoors - MVP Map</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    .sidebar {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1;
    }
    .weather, .gear-list {
      margin-top: 10px;
      font-size: 14px;
    }
    .legend {
      margin-top: 10px;
      font-size: 13px;
      line-height: 1.4;
    }
    .legend-color {
      display: inline-block;
      width: 14px;
      height: 14px;
      margin-right: 6px;
      vertical-align: middle;
      border-radius: 3px;
    }
    #layerPanel {
      position: absolute;
      bottom: 60px;
      left: 10px;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      display: none;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="sidebar">
    <h3>Lost Outdoors</h3>
    <div class="weather">Weather: <span id="weather"></span></div>
    <div class="legend">
      <h4>Trail Legend</h4>
      <div><span class="legend-color" style="background:#28a745"></span> Hiker Trail</div>
      <div><span class="legend-color" style="background:#1E90FF"></span> Bike Trail</div>
      <div><span class="legend-color" style="background:#996633"></span> Horse Trail</div>
      <div><span class="legend-color" style="background:#DAA520"></span> County MVUM</div>
      <div><span class="legend-color" style="background:#0000FF"></span> Forest Service MVUM</div>
    </div>
  </div>

  <div id="layerPanel">
    <label><input type="checkbox" id="toggle-hiker" checked> Hiker Trails</label><br>
    <label><input type="checkbox" id="toggle-bike" checked> Bike Trails</label><br>
    <label><input type="checkbox" id="toggle-horse" checked> Horse Trails</label><br>
    <label><input type="checkbox" id="toggle-mvum-forest" checked> Forest Service Roads</label><br>
    <label><input type="checkbox" id="toggle-mvum-county" checked> County Roads</label><br>
  </div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibW1lYWRvcjE4NyIsImEiOiJjbWMyNzY0eXkwNWIyMmtxOGhrdndiNmwxIn0.ielEabL7E9CJEf5E9baQ4Q';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/outdoors-v12',
      center: [-88.688, 37.5],
      zoom: 12
    });

    map.addControl(new mapboxgl.NavigationControl());

    map.on('load', () => {
      map.addSource('trails', {
        type: 'geojson',
        data: '/data/TrailsGeoJson.json'
      });

      map.addSource('mvum', {
        type: 'geojson',
        data: '/data/MVUM.json'
      });

      class LayersToggleControl {
        onAdd(map) {
          this._map = map;
          this._container = document.createElement('div');
          this._container.className = 'mapboxgl-ctrl mapboxgl-ctrl-group';

          this._button = document.createElement('button');
          this._button.id = 'layersToggle';
          this._button.title = 'Toggle Layers Panel';
          this._button.style.border = 'none';
          this._button.style.background = 'transparent';
          this._button.style.padding = '0';
          this._button.style.display = 'flex';
          this._button.style.alignItems = 'center';
          this._button.style.justifyContent = 'center';

          const icon = document.createElement('img');
          icon.src = 'https://raw.githubusercontent.com/mmeador187/lost-outdoors/main/assets/layers.png';
          icon.alt = 'Layers';
          icon.style.width = '40px';
          icon.style.height = '40px';
          icon.style.borderRadius = '8px';
          icon.style.boxShadow = '0 2px 6px rgba(0, 0, 0, 0.25)';
          icon.style.cursor = 'pointer';
          icon.style.objectfit = 'contain';
          icon.style.background = 'transparent';

          this._button.appendChild(icon);
          this._container.appendChild(this._button); // ✅ This line was missing

          this._button.addEventListener('click', () => {
            const panel = document.getElementById('layerPanel');
            if (panel) {
              panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            }
          });

          return this._container;
        }

        onRemove() {
          this._container.parentNode.removeChild(this._container);
          this._map = undefined;
        }
      }

      map.addControl(new LayersToggleControl(), 'bottom-left');

      if (navigator.geolocation) {
  navigator.geolocation.watchPosition(
    position => {
      const { latitude, longitude } = position.coords;

      const userLocation = [longitude, latitude];

      // Center the map on the user
      map.flyTo({
        center: userLocation,
        zoom: 14, // adjust zoom level if needed
        speed: 1.2
      });

      // Optional: Add or update a marker
      if (!map.getSource('user-location')) {
        map.addSource('user-location', {
          type: 'geojson',
          data: {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: userLocation
            }
          }
        });

        map.addLayer({
          id: 'user-location',
          type: 'circle',
          source: 'user-location',
          paint: {
            'circle-radius': 6,
            'circle-color': '#0074D9',
            'circle-stroke-width': 2,
            'circle-stroke-color': '#fff'
          }
        });
      } else {
        // Update the existing marker
        map.getSource('user-location').setData({
          type: 'Feature',
          geometry: {
            type: 'Point',
            coordinates: userLocation
          }
        });
      }
    },
    error => {
      console.error('Geolocation error:', error);
    },
    {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 10000
    }
  );
} else {
  alert('Geolocation is not supported by your browser.');
}
      
      map.addLayer({
        id: 'trails-hiker',
        type: 'line',
        source: 'trails',
        filter: ['in', 'Type2', 
          'Hiker Only Forest Service Trail',
          'Hiker/Equestrian Forest Service Trail',
          'Hiker/Mountain Bike Forest Service Trail'
        ],
        paint: {
          'line-color': '#28a745',
          'line-width': 3
        }
      });

      map.addLayer({
        id: 'trails-horse',
        type: 'line',
        source: 'trails',
        filter: ['in', ['get', 'Type2'], 'Hiker/Equestrian Forest Service Trail'],
        paint: {
          'line-color': '#a0522d',
          'line-width': 2,
          'line-offset': -2
        }
      });

      map.addLayer({
        id: 'trails-bike',
        type: 'line',
        source: 'trails',
        filter: ['==', ['get', 'Type2'], 'Hiker/Mountain Bike Forest Service Trail'],
        paint: {
          'line-color': '#ffc107',
          'line-width': 2
        }
      });

      map.addLayer({
        id: 'mvum-forest-service',
        type: 'line',
        source: 'mvum',
        filter: ['==', ['slice', ['get', 'JURISDICTI'], 0, 1], 'F'],
        paint: {
          'line-color': '#0000FF',
          'line-width': 3
        },
        layout: {
          visibility: 'visible'
        }
      });

      map.addLayer({
        id: 'mvum-county',
        type: 'line',
        source: 'mvum',
        filter: ['==', ['slice', ['get', 'JURISDICTI'], 0, 1], 'C'],
        paint: {
          'line-color': '#DAA520',
          'line-width': 3
        },
        layout: {
          visibility: 'visible'
        }
      });

      // Toggle controls
      document.getElementById('toggle-mvum-forest').onchange = e =>
        map.setLayoutProperty('mvum-forest-service', 'visibility', e.target.checked ? 'visible' : 'none');

      document.getElementById('toggle-mvum-county').onchange = e =>
        map.setLayoutProperty('mvum-county', 'visibility', e.target.checked ? 'visible' : 'none');

      document.getElementById('toggle-hiker').onchange = e =>
        map.setLayoutProperty('trails-hiker', 'visibility', e.target.checked ? 'visible' : 'none');

      document.getElementById('toggle-bike').onchange = e =>
        map.setLayoutProperty('trails-bike', 'visibility', e.target.checked ? 'visible' : 'none');

      document.getElementById('toggle-horse').onchange = e =>
        map.setLayoutProperty('trails-horse', 'visibility', e.target.checked ? 'visible' : 'none');

      map.on('click', (e) => {
        new mapboxgl.Marker()
          .setLngLat(e.lngLat)
          .addTo(map);
      });

      // Weather API
      fetch('https://api.openweathermap.org/data/2.5/weather?lat=37.5&lon=-88.688&appid=374a4a81fc726009ff89323415d557e5&units=imperial')
        .then(res => res.json())
        .then(data => {
          document.getElementById('weather').innerText = `${data.weather[0].main}, ${data.main.temp.toFixed(0)}°F`;
        });
    });
  </script>
</body>
</html>
